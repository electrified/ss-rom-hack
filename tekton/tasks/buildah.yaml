apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: buildah-insecure
spec:
  params:
    - name: IMAGE
      type: string
      description: Full image reference including tag
    - name: DOCKERFILE
      type: string
      description: Path to Dockerfile
      default: ./Dockerfile
    - name: CONTEXT
      type: string
      description: Build context directory
      default: .
    - name: TLSVERIFY
      type: string
      description: Verify TLS on push
      default: "false"
  workspaces:
    - name: source
      description: Source code workspace
  steps:
    - name: build
      image: quay.io/buildah/stable:latest
      workingDir: $(workspaces.source.path)/source
      securityContext:
        privileged: true
      volumeMounts:
        - name: varlibcontainers
          mountPath: /var/lib/containers
      script: |
        #!/bin/sh
        set -eu
        buildah bud \
          --storage-driver=vfs \
          --tls-verify=false \
          -f $(params.DOCKERFILE) \
          -t $(params.IMAGE) \
          $(params.CONTEXT)
    - name: push
      image: quay.io/buildah/stable:latest
      workingDir: $(workspaces.source.path)/source
      securityContext:
        privileged: true
      volumeMounts:
        - name: varlibcontainers
          mountPath: /var/lib/containers
      script: |
        #!/bin/sh
        set -eu
        buildah push \
          --storage-driver=vfs \
          --tls-verify=$(params.TLSVERIFY) \
          $(params.IMAGE)
  volumes:
    - name: varlibcontainers
      emptyDir: {}
